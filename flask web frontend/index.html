<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iNaturalist Label Generator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2d8a5f;
            --primary-light: #e6f3ed;
            --primary-dark: #1e5d3f;
            --secondary: #0097b2;
            --accent: #ffb100;
            --grey-100: #f9f9fa;
            --grey-200: #e9ecef;
            --grey-300: #dee2e6;
            --grey-400: #ced4da;
            --grey-500: #adb5bd;
            --grey-600: #6c757d;
            --grey-700: #495057;
            --grey-800: #343a40;
            --grey-900: #212529;
            --danger: #dc3545;
            --success: #28a745;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--grey-800);
            background-color: var(--grey-100);
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        header .container {
            display: grid;
            grid-template-columns: 50px 1fr 50px;
            align-items: center;
        }

        .header-left {
            width: 50px;
            justify-self: start;
        }

        .logo-img {
            height: 32px;
            display: block;
        }

        .header-center {
            justify-self: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
        }

        .header-right {
            justify-self: end;
        }

        main {
            padding-bottom: 3rem;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--grey-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .observation-list {
            margin-bottom: 1.5rem;
        }

        .observation-input {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
            transition: var(--transition);
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--grey-300);
        }

        .observation-input:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .observation-input:last-child {
            border: 1px dashed var(--grey-400);
            background-color: var(--grey-100);
        }

        .observation-number {
            font-weight: 500;
            color: var(--grey-600);
            width: 40px;
            text-align: right;
        }

        .obs-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid var(--grey-300);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .obs-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .result {
            min-width: 180px;
            font-weight: 500;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .result-item {
            margin-bottom: 4px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #007d93;
        }

        .btn-accent {
            background-color: var(--accent);
            color: var(--grey-900);
        }

        .btn-accent:hover:not(:disabled) {
            background-color: #e09900;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--grey-400);
            color: var(--grey-700);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--grey-200);
        }

        .btn-icon {
            padding: 0.6rem;
            border-radius: 50%;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .warning {
            padding: 0.75rem 1rem;
            background-color: #fff3cd;
            color: #856404;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .warning i {
            font-size: 1.1rem;
        }

        .help-card {
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }

        .help-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-text {
            color: var(--grey-700);
            margin-bottom: 1rem;
        }

        footer {
            background-color: white;
            border-top: 1px solid var(--grey-200);
            padding: 1.5rem 0;
            color: var(--grey-600);
            text-align: center;
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .footer-link {
            color: var(--grey-700);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-link:hover {
            color: var(--primary);
        }

        .species-name {
            font-style: italic;
        }

        /* Toast notification */
        #toast {
            visibility: hidden;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--grey-800);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Responsive styles */
        @media screen and (max-width: 768px) {
            .observation-input {
                flex-wrap: wrap;
            }
            
            .obs-input {
                width: 100%;
                order: 1;
            }
            
            .result {
                width: 100%;
                order: 3;
                margin-top: 0.5rem;
                margin-left: 40px;
            }
            
            .actions {
                order: 2;
            }
            
            .observation-number {
                order: 0;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal {
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: min(900px, 92vw);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-title {
            font-weight: 600;
        }
        .modal-body {
            padding: 1rem;
            overflow: auto;
        }
        .modal-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--grey-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        /* Make the OK button larger for easier clicking */
        #logModal .modal-footer #logModalOk {
            min-width: 160px;
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }
        .ansi-log {
            background: #0f172a;
            color: #e2e8f0;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border-radius: 6px;
            padding: 12px;
            white-space: pre-wrap;
        }
        .ansi-red { color: #f87171; }
        .ansi-green { color: #34d399; }
        .ansi-blue { color: #60a5fa; }
        .ansi-yellow { color: #fbbf24; }
        .ansi-magenta { color: #d946ef; }
        .ansi-cyan { color: #22d3ee; }
        .ansi-reset { color: inherit; }

        /* Custom tooltip that supports multi-line content */
        .tooltip-help { position: relative; display: inline-block; cursor: help; }
        .tooltip-help .tooltip-box {
            display: none;
            position: absolute;
            top: 1.8rem;
            left: 0;
            background: #ffffff;
            color: var(--grey-800);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            box-shadow: var(--box-shadow);
            padding: 0.75rem 1rem;
            max-width: 460px;
            line-height: 1.4;
            font-size: 0.9rem;
            white-space: pre-line; /* render \n as line breaks */
            z-index: 1500;
        }
        .tooltip-help:hover .tooltip-box { display: block; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-left">
                <img src="https://static.inaturalist.org/sites/1-logo.svg" alt="iNaturalist Logo" class="logo-img" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%);">
            </div>
            <div class="header-center">
                <h1 class="header-title">iNaturalist Label Generator</h1>
            </div>
            <div class="header-right">
                <a href="https://images.mushroomobserver.org/labels/help" target="_blank" class="btn btn-outline" style="color: white; border-color: rgba(255,255,255,0.3);">
                    <i class="fas fa-question-circle"></i>
                    Help
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-search"></i>
                    Observation Lookup
                    <span class="tooltip-help">
                        <i class="fas fa-info-circle" style="color: var(--grey-200);"></i>
                        <div class="tooltip-box">
                            Input formats:
• iNaturalist: just the number (e.g., 150291663) or the full observation URL
• Mushroom Observer: MO12345 or a Mushroom Observer observation URL (generates an MO label)
• Convert MO→iNat: motoinat12345 or moinat12345 (generates an iNaturalist label from an MO observation)
                        You can enter multiple values separated by spaces or commas.
                        </div>
                    </span>
                </h2>

                <form id="observationForm">
                    <div class="observation-list" id="observationInputs">
                        <div class="observation-input">
                            <span class="observation-number">1</span>
                            <input type="text" id="obs1" name="observations[]" class="obs-input" placeholder="Enter observation number(s)" required autocomplete="off">
                            <span class="result"></span>
                            <div class="actions">
                                <button type="button" class="btn btn-outline btn-icon removeButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="warningMessage" class="warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="warningText"></span>
                    </div>

<div class="form-actions" style="display: flex; flex-direction: column; gap: 1rem;">
                        <div class="actions">
                            <button type="button" id="printRtfButton" class="btn btn-primary">
                                <i class="fas fa-tags"></i>
                                Print RTF Labels
                            </button>
                            <button type="button" id="printPdfButton" class="btn btn-secondary">
                                <i class="fas fa-file-pdf"></i>
                                Print PDF Labels
                            </button>
                            <button type="button" id="addObsButton" class="btn btn-outline">
                                <i class="fas fa-plus"></i>
                                Add observations by date / username
                            </button>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label>
                                <input type="checkbox" id="omitQrCodes">
                                Omit QR Codes
                            </label>
                            <label>
                                <input type="checkbox" name="minilabel" id="minilabel">
                                Print mini-labels
                            </label>
                            <label>
                                <input type="checkbox" name="common_names" id="common_names">
                                Include common names
                            </label>
                            <label>
                                <input type="checkbox" name="omit_notes" id="omit_notes">
                                Omit Notes
                            </label>
                        </div>
                    </div>
                </form>
            </div>

            <div class="help-card">
                <h3 class="help-title">
                    <i class="fas fa-info-circle"></i>
                    Quick Help
                </h3>
                <p class="help-text">
                    Enter iNaturalist or Mushroom Observer observation numbers, URLs, or a combination of both to look up species information for your labels. Add multiple observations as needed - often 8 labels fit on a page. Results appear when you click away from the input or press Enter.
                </p>
                <p class="help-text" style="margin-top: 0.5rem;">
                    Tips:
                    <ul style="margin-top: 0.5rem; padding-left: 1.2rem;">
                        <li><strong>iNaturalist:</strong> Just the number (e.g., <code>150291663</code>) or the full observation URL.</li>
                        <li><strong>Mushroom Observer:</strong> Use <code>MO12345</code> (case-insensitive) or a Mushroom Observer observation URL to generate an MO label.</li>
                        <li><strong>Convert MO → iNat:</strong> Use <code>motoinat12345</code> or <code>moinat12345</code> to convert the MO observation and generate an iNaturalist label.</li>
                    </ul>
                </p>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                    <button type="button" id="downloadCsvButton" class="btn btn-secondary">
                        <i class="fas fa-file-csv"></i>
                        Download CSV
                    </button>
                    <a href="/labels/help" class="btn btn-accent">
                        <i class="fas fa-book"></i>
                        Full Help
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="/labels/todo" class="footer-link">
                    <i class="fas fa-tasks"></i>
                    To-Do List
                </a>
                <a href="https://www.inaturalist.org" target="_blank" class="footer-link">
                    <i class="fas fa-external-link-alt"></i>
                    iNaturalist
                </a>
                <a href="https://mushroomobserver.org" target="_blank" class="footer-link">
                    <img src="{{ url_for('static', filename='mo_favicon.ico') }}" alt="Mushroom Observer Icon" style="height: 1em; vertical-align: middle; margin-right: 0.25em;">
                    Mushroom Observer
                </a>
                <a href="https://github.com/AlanRockefeller/inat.label.py" target="_blank" class="footer-link">
                    <i class="fab fa-github"></i>
                    GitHub Repository
                </a>
                <a href="https://images.mushroomobserver.org/labels/help" target="_blank" class="footer-link">
                    <i class="fas fa-question-circle"></i>
                    Help
                </a>
            </div>
            <p>By Alan Rockefeller - <a href="https://github.com/AlanRockefeller/inat.label.py/blob/main/LICENSE.md" target="_blank" class="footer-link">GNU General Public License v3.0</a></p>
        </div>
    </footer>

<div id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Log Modal -->
    <div id="logModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="logModalTitle">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="logModalTitle">
                    Label Generation Output
                </div>
                <button id="logModalCloseX" class="btn btn-outline btn-icon" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="logContent" class="ansi-log"></div>
            </div>
            <div class="modal-footer">
                <button id="logModalOk" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Add Observations Modal -->
    <div id="addObsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="addObsTitle">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="addObsTitle">Add Observations</div>
                <button id="addObsCloseX" class="btn btn-outline btn-icon" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; align-items: end;">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label for="addObsStartDate" style="display:block; font-size:0.9rem; color:var(--grey-700);">Start Date</label>
                            <input type="date" id="addObsStartDate" class="obs-input" style="padding:0.5rem;">
                        </div>
                        <div>
                            <label for="addObsEndDate" style="display:block; font-size:0.9rem; color:var(--grey-700);">End Date</label>
                            <input type="date" id="addObsEndDate" class="obs-input" style="padding:0.5rem;">
                            <div style="margin-top:0.25rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <button type="button" class="btn btn-outline btn-sm" id="quickToday">Today</button>
                                <button type="button" class="btn btn-outline btn-sm" id="quickYesterday">Yesterday</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="addObsUser" style="display:block; font-size:0.9rem; color:var(--grey-700);">iNat Username</label>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="text" id="addObsUser" class="obs-input" placeholder="username" style="flex:1;">
                            <span id="addObsUserStatus" aria-live="polite" title=""></span>
                        </div>
                    </div>
                    <div>
                        <label for="addObsTaxon" style="display:block; font-size:0.9rem; color:var(--grey-700);">Taxon (name or ID)</label>
                        <input type="text" id="addObsTaxon" class="obs-input" placeholder="e.g., Fungi or 47170">
                    </div>
                    <div>
                        <button type="button" id="addObsPreview" class="btn btn-secondary" style="margin-top:1.25rem; width:100%">
                            <i class="fas fa-search"></i> Preview
                        </button>
                    </div>
                </div>
                <div id="addObsResults" style="margin-top:1rem; max-height:240px; overflow:auto; border:1px solid var(--grey-300); border-radius:8px; padding:0.5rem; display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="addObsCancel" class="btn btn-outline">Cancel</button>
                <button type="button" id="addObsConfirm" class="btn btn-primary" disabled>Add</button>
            </div>
        </div>
    </div>

<script>
    $(document).ready(function() {
        let observationCount = 1;
        const maxObservations = 500;
        let previewCache = {};

        function showToast(message, isSuccess = true) {
            $('#toastMessage').text(message);
            $('#toast').removeClass('show');
            if (isSuccess) {
                $('#toast i').removeClass('fa-exclamation-circle').addClass('fa-check-circle');
                $('#toast').css('background-color', 'var(--success)');
            } else {
                $('#toast i').removeClass('fa-check-circle').addClass('fa-exclamation-circle');
                $('#toast').css('background-color', 'var(--danger)');
            }
            void $('#toast')[0].offsetWidth;
            $('#toast').addClass('show');
            setTimeout(function() { $('#toast').removeClass('show'); }, 3000);
        }

        function updateObservationNumbers() {
            $('.observation-number').each(function(index) {
                $(this).text(index + 1);
            });
        }

        function countTotalObservations() {
            let total = 0;
            $('.obs-input').each(function() {
                const inputValue = $(this).val().trim();
                if (inputValue !== '') {
                    const obsIds = parseObservationInput(inputValue);
                    total += obsIds.length;
                }
            });
            return total;
        }

        function updateWarningMessage() {
            const total = countTotalObservations();
            const warningDiv = $('#warningMessage');
            const warningText = $('#warningText');
            if (total > maxObservations) {
                warningText.text(`You have entered ${total} observations. If you need to make more than ${maxObservations} labels, please contact Alan Rockefeller to raise the limit.`);
                warningDiv.show();
            } else {
                warningDiv.hide();
            }
        }

	    function addObservationField() {
		observationCount++;
		const newField = `
		    <div class="observation-input">
			<span class="observation-number">${observationCount}</span>
			<input type="text"
			       id="obs${observationCount}"
			       name="observations[]"
			       class="obs-input"
			       placeholder="Enter observation number(s)"
			       autocomplete="off">
			<span class="result"></span>
			<div class="actions">
			    <button type="button" class="btn btn-outline btn-icon removeButton">
				<i class="fas fa-times"></i>
			    </button>
			</div>
		    </div>`;
		$('#observationInputs').append(newField);
	    }


	// 2. Actually look up an observation and render the result
	function lookupObservation($input) {
	    const resultSpan = $input.siblings('.result');
	    const raw = $input.val().trim();

	    resultSpan.empty();
	    if (!raw) return;

	    const obsIds = parseObservationInput(raw);
	    if (!obsIds.length) return;

	    // spinner
	    resultSpan.html('<i class="fas fa-spinner fa-spin"></i> Loading...');

	    $.ajax({
		url: '/labels/lookup_batch',
		type: 'POST',
		data: $.param({ 'obs_ids[]': obsIds }),
		success: function(resp) {
		    const items = (resp && resp.items) ? resp.items : [];
		    const resultsDiv = $('<div class="multiple-results"></div>');

		    items.forEach(function(data, index) {
			const original = data.original_input || data.input || obsIds[index];
			const resultItem = $('<div class="result-item"></div>');

			if (data.error) {
			    resultItem.html(
				`<span style="color: var(--danger);">
				    <i class="fas fa-exclamation-circle"></i>
				    ${escapeHtml(original)}: ${escapeHtml(data.error || '')}
				</span>`
			    );
			} else {
			    // pick a display label based on what the user typed
			    let displayText;
			    const lower = (original || '').toLowerCase();

			    if (/^mo:\d+$/i.test(original)) {
				const moNum = original.substring(3);
				if ((data.inat_id || '').toLowerCase().startsWith('mo')) {
				    displayText = `MO${moNum}`;
				} else {
				    displayText = `MO${moNum} → iNat#${data.inat_id}`;
				}
			    } else if (/^mo\d+$/i.test(original)) {
				displayText = original.toUpperCase();
			    } else if (lower.startsWith('motoinat') || lower.startsWith('moinat') || lower.startsWith('inatmo')) {
				const moNum = original.replace(/\D+/g, '');
				displayText = `MO${moNum} → iNat#${data.inat_id}`;
			    } else {
				displayText = `#${data.inat_id}`;
			    }

			    resultItem.html(
				`<span>
				    ${displayText}:
				    <span style="color:${data.color}" class="species-name">
					${escapeHtml(data.scientific_name || '')}
				    </span>
				    <small style="color: var(--grey-600);">
					<i class="fas fa-user"></i> ${escapeHtml(data.user_id || '')}
				    </small>
				</span>`
			    );
			}

			if (index < items.length - 1) {
			    resultItem.append('<hr style="margin: 4px 0; border-top: 1px dashed var(--grey-300);">');
			}

			resultsDiv.append(resultItem);
		    });

		    resultSpan.empty().append(resultsDiv);
		},
		error: function() {
		    resultSpan.html('<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error fetching details</span>');
		}
	    });
	}

	// split the user input into IDs
	function parseObservationInput(input) {
	    const results = [];
	    const parts = input.split(/[\s,]+/).filter(part => part.trim() !== '');

	    parts.forEach(part => {
		const p = part.trim();

		if (/^motoinat\d+$/i.test(p) || /^moinat\d+$/i.test(p) || /^inatmo\d+$/i.test(p)) {
		    results.push(p.toLowerCase());
		    return;
		}

		if (/^mo\d+$/i.test(p)) {
		    const digits = p.replace(/^[^0-9]+/, '');
		    results.push(`MO${digits}`);
		    return;
		}

		if (p.includes('mushroomobserver.org')) {
		    const match = p.match(/\/(\d+)$/);
		    if (match && match[1]) {
			results.push(`MO${match[1]}`);
			return;
		    }
		}

		if (p.includes('inaturalist.org/observations/')) {
		    const match = p.match(/\/observations\/(\d+)/);
		    if (match && match[1]) {
			results.push(match[1]);
			return;
		    }
		}

		if (/^\d+$/.test(p)) {
		    results.push(p);
		}
	    });

	    return results;
	}

	function lookupObservation($input) {
	    const resultSpan = $input.siblings('.result');
	    const raw = $input.val().trim();

	    resultSpan.empty();
	    if (!raw) return;

	    const obsIds = parseObservationInput(raw);
	    if (!obsIds.length) return;

	    resultSpan.html('<i class="fas fa-spinner fa-spin"></i> Loading...');

	    $.ajax({
		url: '/labels/lookup_batch',
		type: 'POST',
		data: $.param({ 'obs_ids[]': obsIds }),
		success: function(resp) {
		    const items = (resp && resp.items) ? resp.items : [];
		    const resultsDiv = $('<div class="multiple-results"></div>');

		    items.forEach(function(data, index) {
			const original = data.original_input || data.input || obsIds[index];
			const resultItem = $('<div class="result-item"></div>');

			if (data.error) {
			    resultItem.html(
				`<span style="color: var(--danger);">
				    <i class="fas fa-exclamation-circle"></i>
				    ${escapeHtml(original)}: ${escapeHtml(data.error || '')}
				</span>`
			    );
			} else {
			    let displayText;
			    const lower = (original || '').toLowerCase();

			    if (/^mo:\d+$/i.test(original)) {
				const moNum = original.substring(3);
				if ((data.inat_id || '').toLowerCase().startsWith('mo')) {
				    displayText = `MO${moNum}`;
				} else {
				    displayText = `MO${moNum} → iNat#${data.inat_id}`;
				}
			    } else if (/^mo\d+$/i.test(original)) {
				displayText = original.toUpperCase();
			    } else if (lower.startsWith('motoinat') || lower.startsWith('moinat') || lower.startsWith('inatmo')) {
				const moNum = original.replace(/\D+/g, '');
				displayText = `MO${moNum} → iNat#${data.inat_id}`;
			    } else {
				displayText = `#${data.inat_id}`;
			    }

			    resultItem.html(
				`<span>
				    ${displayText}:
				    <span style="color:${data.color}" class="species-name">
					${escapeHtml(data.scientific_name || '')}
				    </span>
				    <small style="color: var(--grey-600);">
					<i class="fas fa-user"></i> ${escapeHtml(data.user_id || '')}
				    </small>
				</span>`
			    );
			}

			if (index < items.length - 1) {
			    resultItem.append('<hr style="margin: 4px 0; border-top: 1px dashed var(--grey-300);">');
			}

			resultsDiv.append(resultItem);
		    });

		    resultSpan.empty().append(resultsDiv);
		},
		error: function() {
		    resultSpan.html('<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error fetching details</span>');
		}
	    });
	}

	$('#observationInputs').on('input', '.obs-input', function() {
	    const $this = $(this);
	    if ($this.val().trim() !== '' && $this.closest('.observation-input').is(':last-child')) {
		addObservationField();
	    }
	    updateWarningMessage();
	});

	$('#observationInputs').on('blur', '.obs-input', function() {
	    if ($(this).val().trim() !== '') {
		lookupObservation($(this));
	    }
	});

        $('#observationForm').on('keydown', function(e) {
            if (e.key === 'Enter' && $(e.target).is('input.obs-input')) {
                e.preventDefault(); // Prevent default form submission
                const $currentInput = $(e.target);
                const $nextInput = $currentInput.closest('.observation-input').next().find('.obs-input');

                if ($nextInput.length) {
                    $nextInput.focus();
                } else {
                    // If it's the last input, add a new one and focus it
                    addObservationField();
                    $('.obs-input').last().focus();
                }
            }
        });



        $('#downloadCsvButton').click(function(e) {
            e.preventDefault();
            const totalObservations = countTotalObservations();
            if (totalObservations === 0) {
                showToast('Please enter at least one observation number', false);
                return;
            }
            if (totalObservations > maxObservations && !confirm(`Warning: You are attempting to process ${totalObservations} observations. If you need to make more than ${maxObservations} labels, please contact Alan Rockefeller to raise the limit. Do you want to continue?`)) {
                return;
            }

            var formData = new FormData();
            $('.obs-input').each(function() {
                const inputValue = $(this).val().trim();
                if (inputValue !== '') {
                    const obsIds = parseObservationInput(inputValue);
                    obsIds.forEach(id => formData.append('observations[]', id));
                }
            });

            const submitBtn = $(this);
            const originalText = submitBtn.html();
            submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Processing...').prop('disabled', true);

            $.ajax({
                url: '/labels/submit',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success(response) {
                    submitBtn.html(originalText).prop('disabled', false);
                    var blob = new Blob([response], { type: 'text/csv' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'observations.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('CSV downloaded successfully!');
                },
                error(xhr) {
                    submitBtn.html(originalText).prop('disabled', false);
                    let msg = 'The server took too long to respond while generating the CSV. This can happen with very large batches. Please try fewer observations per request, split the job, or wait a moment and retry.';
                    if (xhr && (xhr.status === 504 || (xhr.responseText || '').includes('504 Gateway'))) {
                        msg = 'Request timed out while generating the CSV (Gateway Timeout). Try reducing the number of observations per request, splitting into smaller batches, or waiting a bit and retrying. The labels may still be generated, but the download might not start automatically. After a few minutes, check the download link on the Help page.';
                    }
                    showErrorModal(msg);
                }
            });
        });

function collectObservationsFormData() {
            var formData = new FormData();
            $('.obs-input').each(function() {
                const inputValue = $(this).val().trim();
                if (inputValue !== '') {
                    const obsIds = parseObservationInput(inputValue);
                    obsIds.forEach(id => formData.append('observations[]', id));
                }
            });
            return formData;
        }

        function escapeHtml(s) {
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function ansiToHtml(ansiText) {
            if (!ansiText) return '';
            let html = escapeHtml(ansiText);
            // Generic SGR parser: replace color codes with spans, resets with </span>
            // Handle both ESC (\x1b) and literal \u001b sequences
            const replacer = (full, codes) => {
                const parts = codes.split(';');
                if (parts.includes('0') || parts.includes('39')) return '</span>';
                // Map any color present in the sequence
                const map = {
                    '31': 'ansi-red', '91': 'ansi-red',
                    '32': 'ansi-green', '92': 'ansi-green',
                    '33': 'ansi-yellow', '93': 'ansi-yellow',
                    '34': 'ansi-blue', '94': 'ansi-blue',
                    '35': 'ansi-magenta', '95': 'ansi-magenta',
                    '36': 'ansi-cyan', '96': 'ansi-cyan'
                };
                for (const p of parts) {
                    if (map[p]) return `<span class="${map[p]}">`;
                }
                return '';
            };
            html = html
                .replace(/\x1b\[([0-9;]+)m/g, replacer)
                .replace(/\\u001b\[([0-9;]+)m/g, replacer);
            return html;
        }

        // Semantic colorization fallback when no ANSI codes are present
        function semanticColorize(text) {
            const esc = escapeHtml(text);
            // Color "Added label for ..." by major group
            if (/^Added label for /i.test(text)) {
                let cls = null;
                if (/Fungi/i.test(text)) cls = 'ansi-blue';
                else if (/Plantae/i.test(text)) cls = 'ansi-green';
                else if (/Protozoa/i.test(text)) cls = 'ansi-magenta';
                else if (/Insecta/i.test(text)) cls = 'ansi-red';
                else if (/(Aves|Reptilia|Mammalia)/i.test(text)) cls = 'ansi-blue';
                if (cls) return `<span class="${cls}">${esc}</span>`;
            }
            // Color "generated" red in Summary when counts differ
            if (/^Summary:/i.test(text)) {
                const mReq = text.match(/requested\s+(\d+)/i);
                const mGen = text.match(/generated\s+(\d+)/i);
                if (mReq && mGen && mReq[1] !== mGen[1]) {
                    return esc.replace(/generated/i, '<span class="ansi-red">generated</span>');
                }
            }
            return esc;
        }

        function showLogModal(ansiLog) {
            const html = ansiToHtml(ansiLog);
            $('#logModalTitle').text('Label Generation Output');
            $('#logContent').html(html);
            $('#logModal').css('display', 'flex');
        }

        function showTooManyJobsModal(message) {
            showErrorModal(message, 'Too Many Concurrent Jobs');
        }

        function showErrorModal(messageHtml, title = 'Error') {
            $('#logModalTitle').html(`<i class="fas fa-exclamation-triangle"></i> ${title}`);
            $('#logContent').html(`<div>${messageHtml}</div>`);
            $('#logModal').css('display', 'flex');
        }

        $('#logModalOk, #logModalCloseX').on('click', function() {
            $('#logModal').hide();
        });

        function setToday(el) {
            const d = new Date();
            const pad = n => String(n).padStart(2,'0');
            el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        }

        function debounce(fn, delay) {
            let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), delay); };
        }

        const setUserStatus = (state) => {
            const el = document.getElementById('addObsUserStatus');
            if (!el) return;
            if (state === 'ok') {
el.innerHTML = '<i class="fa-solid fa-circle-check" style="color: var(--success);"></i>';
                el.setAttribute('title','User exists');
            } else if (state === 'warn') {
el.innerHTML = '<i class="fa-solid fa-circle-exclamation" style="color: var(--danger);"></i>';
                el.setAttribute('title','User not found');
            } else {
                el.innerHTML = '';
                el.removeAttribute('title');
            }
        };

        const checkUserExists = debounce(async () => {
            const usernameInput = $('#addObsUser');
            let username = (usernameInput.val() || '').trim();
            if (!username) { setUserStatus('none'); return; }

            async function tryUsername(user) {
                try {
                    const url = `https://api.inaturalist.org/v1/users/autocomplete?q=${encodeURIComponent(user)}&per_page=10`;
                    const resp = await fetch(url, { method: 'GET' });
                    if (!resp.ok) return false;
                    const data = await resp.json();
                    return (data.results || []).some(u => (u.login || '').toLowerCase() === user.toLowerCase());
                } catch (_) {
                    return false;
                }
            }

            let found = await tryUsername(username);
            if (found) {
                setUserStatus('ok');
            } else if (username.includes(' ')) {
                const usernameWithUnderscores = username.replace(/ /g, '_');
                let foundWithUnderscores = await tryUsername(usernameWithUnderscores);
                if (foundWithUnderscores) {
                    usernameInput.val(usernameWithUnderscores); // Correct the username in the input field
                    setUserStatus('ok');
                } else {
                    setUserStatus('warn');
                }
            } else {
                setUserStatus('warn');
            }
        }, 400);

	function addObservationsToForm(observations) {
	    if (!observations || !observations.length) return;

	    observations.forEach(function(obsData) {
		// find an existing empty row
		let $empty = $('.obs-input').filter(function () {
		    return $(this).val().trim() === '';
		}).first();

		// if none, create one
		if (!$empty.length) {
		    addObservationField();
		    $empty = $('.obs-input').last();
		}

		// put this id in the row
		$empty.val(obsData.id);

        // Render the result directly from cached data
        const resultSpan = $empty.siblings('.result');
        const resultItem = $('<div class="result-item"></div>');

        const displayText = `#${obsData.id}`;
        resultItem.html(
            `<span>
                ${displayText}:
                <span style="color:${obsData.color || 'black'}" class="species-name">
                    ${escapeHtml(obsData.scientific_name || 'Unknown')}
                </span>
            </span>`
        );
        resultSpan.empty().append(resultItem);

		// IMPORTANT: pretend the user typed, so the "if last field filled, add another" logic runs
		$empty.trigger('input');
	    });

	    updateObservationNumbers();
	    updateWarningMessage();
	    showToast(`Added ${observations.length} observations`);
	}

	function batchLookupObservations(inputs) { // inputs is an array of jQuery objects
	    const obsIds = inputs.map($input => $input.val().trim());
	    
	    inputs.forEach($input => {
		$input.siblings('.result').html('<i class="fas fa-spinner fa-spin"></i> Loading...');
	    });

	    if (obsIds.length === 0) return;

	    $.ajax({
		url: '/labels/lookup_batch',
		type: 'POST',
		data: $.param({ 'obs_ids[]': obsIds }),
		success: function(resp) {
		    const items = (resp && resp.items) ? resp.items : [];

		    items.forEach((data, index) => {
			const $input = inputs[index];
			if (!$input) return;

			const resultSpan = $input.siblings('.result');
			const original = data.original_input || data.input || obsIds[index];
			const resultItem = $('<div class="result-item"></div>');

			if (data.error) {
			    resultItem.html(
				`<span style="color: var(--danger);">
				    <i class="fas fa-exclamation-circle"></i>
				    ${escapeHtml(original)}: ${escapeHtml(data.error || '')}
				</span>`
			    );
			} else {
			    let displayText;
			    const lower = (original || '').toLowerCase();

			    if (/^mo:\d+$/i.test(original)) {
				const moNum = original.substring(3);
				if ((data.inat_id || '').toLowerCase().startsWith('mo')) {
				    displayText = `MO${moNum}`;
				} else {
				    displayText = `MO${moNum} → iNat#${data.inat_id}`;
				}
			    } else if (/^mo\d+$/i.test(original)) {
				displayText = original.toUpperCase();
			    } else if (lower.startsWith('motoinat') || lower.startsWith('moinat') || lower.startsWith('inatmo')) {
				const moNum = original.replace(/\D+/g, '');
				displayText = `MO${moNum} → iNat#${data.inat_id}`;
			    } else {
				displayText = `#${data.inat_id}`;
			    }

			    resultItem.html(
				`<span>
				    ${displayText}:
				    <span style="color:${data.color}" class="species-name">
					${escapeHtml(data.scientific_name || '')}
				    </span>
				    <small style="color: var(--grey-600);">
					<i class="fas fa-user"></i> ${escapeHtml(data.user_id || '')}
				    </small>
				</span>`
			    );
			}
			resultSpan.empty().append(resultItem);
		    });
		},
		error: function() {
		    inputs.forEach($input => {
			const resultSpan = $input.siblings('.result');
			resultSpan.html('<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error fetching details</span>');
		    });
		}
	    });
	}

        async function handlePrintStream(btn, format, downloadName, successMsg) {
            const totalObservations = countTotalObservations();
            if (totalObservations === 0) {
                showToast('Please enter at least one observation number', false);
                return;
            }
            if (totalObservations > maxObservations && !confirm(`Warning: You are attempting to print ${totalObservations} labels. This may cause a timeout. Do you want to continue?`)) {
                return;
            }
            const formData = collectObservationsFormData();
            formData.append('format', format);
            if ($('#omitQrCodes').is(':checked')) {
                formData.append('omit_qr_codes', 'on');
            }
            // Add minilabel, common_names, and omit_notes checkboxes to formData if checked
            if ($('#minilabel').is(':checked')) {
                formData.append('minilabel', 'on');
            }
            if ($('#common_names').is(':checked')) {
                formData.append('common_names', 'on');
            }
            if ($('#omit_notes').is(':checked')) {
                formData.append('omit_notes', 'on');
            }
            const originalText = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin"></i> Processing...').prop('disabled', true);
            // Open the modal immediately
            $('#logModalTitle').text('Starting Label Generation...');
            $('#logContent').html('');
            $('#logModal').css('display', 'flex');
            let firstLogMessageReceived = false;

            try {
                // Start job
                const startResp = await fetch('/labels/print_start', { method: 'POST', body: formData });
                if (!startResp.ok) {
                    const errorData = await startResp.json();
                    if (startResp.status === 429 && errorData.error.includes('Too many concurrent jobs')) {
                        showTooManyJobsModal(errorData.error);
                    } else {
                        throw new Error(errorData.error || 'Failed to start print job');
                    }
                }
                const { job_id } = await startResp.json();
                if (!job_id) throw new Error('No job id returned');
                // Stream logs via SSE
                const es = new EventSource(`/labels/print_stream?job_id=${encodeURIComponent(job_id)}`);

                // Fallback polling in case SSE 'done' is blocked by proxies
                const expectedUrl = `/static/jobs/${job_id}/labels.${format}`;
                let downloaded = false;
                const poller = setInterval(async () => {
                    try {
                        const resp = await fetch(expectedUrl, { method: 'HEAD', cache: 'no-store' });
                        if (resp.ok && !downloaded) {
                            downloaded = true;
                            btn.html(originalText).prop('disabled', false);
                            const a = document.createElement('a');
                            a.href = expectedUrl;
                            a.download = downloadName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            const cont = $('#logContent');
                            cont.append(`\n<div style=\"margin-top:8px;\"><a href=\"${expectedUrl}\" download=\"${downloadName}\">Click here to download ${downloadName}</a></div>`);
                            showToast(successMsg);
                            clearInterval(poller);
                        }
                    } catch (_) {}
                }, 2000);

                es.addEventListener('log', (ev) => {
                    try {
                        const line = JSON.parse(ev.data);
                        if (!firstLogMessageReceived) {
                            const match = line.match(/^Generating (\d+) labels, this will take about (.*)$/);
                            if (match && parseInt(match[1]) > 25) {
                                $('#logModalTitle').text(match[0]);
                            } else {
                                $('#logModalTitle').text('Label Generation Output');
                            }
                            firstLogMessageReceived = true;
                        }

                        let html = ansiToHtml(line);
                        if (!/<span class=/.test(html)) {
                            html = semanticColorize(line);
                        }
                        const cont = $('#logContent');
                        cont.append(html + '\n');
                        const mb = $('#logModal .modal-body');
                        mb.scrollTop(mb[0].scrollHeight);
                    } catch (e) {
                        // Fallback append raw
                        const cont = $('#logContent');
                        cont.append(escapeHtml(ev.data) + '\n');
                        const mb = $('#logModal .modal-body');
                        mb.scrollTop(mb[0].scrollHeight);
                    }
                });

                // Some servers deliver unnamed events as 'message'
                es.onmessage = (ev) => {
                    // Try to detect done payload
                    try {
                        const payload = JSON.parse(ev.data);
                        if (payload && typeof payload === 'object' && ('success' in payload)) {
                            btn.html(originalText).prop('disabled', false);
                            if (payload.success && payload.download_url) {
                                downloaded = true;
                                const a = document.createElement('a');
                                a.href = payload.download_url;
                                a.download = downloadName;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                const cont = $('#logContent');
                                cont.append(`\n<div style=\"margin-top:8px;\"><a href=\"${payload.download_url}\" download=\"${downloadName}\">Click here to download ${downloadName}</a></div>`);
                                showToast(successMsg);
                            }
                            clearInterval(poller);
                            es.close();
                        }
                    } catch (_) { /* ignore non-JSON message */ }
                };

                es.addEventListener('done', (ev) => {
                    btn.html(originalText).prop('disabled', false);
                    try {
                        const payload = JSON.parse(ev.data);
                        if (payload.success && payload.download_url) {
                            downloaded = true;
                            // Auto-download
                            const a = document.createElement('a');
                            a.href = payload.download_url;
                            a.download = downloadName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            // Also show a clickable link in case the browser blocks auto-download
                            const cont = $('#logContent');
                            cont.append(`\n<div style=\"margin-top:8px;\"><a href=\"${payload.download_url}\" download=\"${downloadName}\">Click here to download ${downloadName}</a></div>`);
                            showToast(successMsg);
                        } else {
                            showErrorModal('The label file could not be generated. Please try again.');
                        }
                    } catch (e) {
                        showErrorModal('Unexpected response from server.');
                    }
                    clearInterval(poller);
                    es.close();
                });
                es.onerror = function() {
                    // Keep modal open, but notify user of streaming issue
                    // Don't close the stream immediately; the server may be buffering
                };
            } catch (err) {
                btn.html(originalText).prop('disabled', false);
                showErrorModal('Failed to start label generation. Please try again.');
            }
        }

        $('#printRtfButton').click(function() {
            handlePrintStream($(this), 'rtf', 'labels.rtf', 'RTF labels downloaded successfully!');
        });

        $('#printPdfButton').click(function() {
            handlePrintStream($(this), 'pdf', 'labels.pdf', 'PDF labels downloaded successfully!');
        });

        // Add Observations modal handlers
        $('#addObsButton').click(function() {
            $('#addObsResults').hide().empty();
            $('#addObsConfirm').prop('disabled', true);
            const startDateEl = document.getElementById('addObsStartDate');
            const endDateEl = document.getElementById('addObsEndDate');
            setToday(endDateEl);
            const d = new Date();
            d.setDate(d.getDate() - 7);
            const pad = n => String(n).padStart(2,'0');
            startDateEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            $('#addObsUser').val('');
            setUserStatus('none');
            $('#addObsTaxon').val('Fungi');
            $('#addObsModal').css('display','flex');
        });
        $('#addObsCloseX, #addObsCancel').click(function(){
            $('#addObsModal').hide();
        });
        $('#quickToday').click(function(){
            const today = new Date();
            const pad = n => String(n).padStart(2,'0');
            const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
            $('#addObsStartDate').val(todayStr);
            $('#addObsEndDate').val(todayStr);
        });
        $('#quickYesterday').click(function(){
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const pad = n => String(n).padStart(2,'0');
            const yesterdayStr = `${yesterday.getFullYear()}-${pad(yesterday.getMonth()+1)}-${pad(yesterday.getDate())}`;
            $('#addObsStartDate').val(yesterdayStr);
            $('#addObsEndDate').val(yesterdayStr);
        });

        let lastPreviewIds = [];

        // Username existence check: on input/blur
        $('#addObsUser').on('input', checkUserExists);
        $('#addObsUser').on('blur', checkUserExists);

        $('#addObsPreview').click(async function(){
            const startDate = $('#addObsStartDate').val();
            const endDate = $('#addObsEndDate').val();
            const username = $('#addObsUser').val().trim();
            const taxon = $('#addObsTaxon').val().trim();
            if (!startDate || !endDate || !username || !taxon) {
                showToast('Please enter start date, end date, username, and taxon', false);
                return;
            }
            const fd = new FormData();
            fd.append('d1', startDate);
            fd.append('d2', endDate);
            fd.append('username', username);
            fd.append('taxon', taxon);
            $('#addObsResults').show().html('<i class="fas fa-spinner fa-spin"></i> Searching...');
            fetch('/labels/find_observations', { method:'POST', body: fd })
              .then(r => r.json().then(j => ({ok:r.ok, j})) )
              .then(({ok, j}) => {
                  if (!ok) throw new Error(j.error || 'Search failed');
                  let items = j.items || [];
                  lastPreviewIds = items.map(x => x.id); // Store all IDs from original response

                  // Clear and populate cache
                  previewCache = {};
                  items.forEach(item => {
                      previewCache[item.id] = item;
                  });

                  let warningMessage = '';
                  if (items.length > maxObservations) {
                      const lastAllowedObservation = items[maxObservations - 1];
                      const suggestedEndDate = lastAllowedObservation.observed_on.split('T')[0];
                      warningMessage = `<div style="padding: 0.5rem; background-color: #fff3cd; color: #856404; border-radius: 8px; margin-bottom: 0.5rem;">
                          <i class="fas fa-exclamation-triangle"></i>
                          Found ${items.length} observations. Showing the first ${maxObservations}. To stay under the limit, try setting the end date to ${suggestedEndDate}.
                          </div>`;
                      items = items.slice(0, maxObservations); // Truncate for display
                  }

                  if (!items.length) {
                      $('#addObsResults').html('<div>No observations found.</div>');
                      $('#addObsConfirm').prop('disabled', true);
                      return;
                  }
                  const rows = items.map(x => `<label style=\"display:block; margin:2px 0;\"><input type=\"checkbox\" class=\"addObsRowCk\" data-id=\"${x.id}\" checked> #${x.id} — <span class="species-name" style="color:${escapeHtml(x.color || 'black')}">${escapeHtml(x.scientific_name || '')}</span></label>`).join('');
                  const header = `<div style=\"display:flex; align-items:center; justify-content:space-between;\"><div style=\"font-size:0.95rem;\">Found ${lastPreviewIds.length} observations</div><div><label style=\"user-select:none;\"><input type=\"checkbox\" id=\"addObsSelectAll\" checked> Select all</label></div></div>`;
                  const body = `<div id=\"addObsList\" style=\"margin-top:0.5rem;\">${rows}</div>`;
                  const footer = `<div id=\"addObsSelectedCount\" style=\"margin-top:0.5rem; font-size:0.9rem;\">Selected: ${items.length} of ${lastPreviewIds.length}</div>`;
                  $('#addObsResults').html(warningMessage + header + body + footer);
                  $('#addObsConfirm').prop('disabled', false);
              })
              .catch(err => {
                  $('#addObsResults').html(`<span style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${escapeHtml(err.message)}</span>`);
                  $('#addObsConfirm').prop('disabled', true);
              });
        });
        function updateAddObsSelectionState() {
            const total = $('#addObsList .addObsRowCk').length;
            const selected = $('#addObsList .addObsRowCk:checked').length;
            $('#addObsSelectedCount').text(`Selected: ${selected} of ${total}`);
            $('#addObsConfirm').prop('disabled', selected === 0);
            if (selected === total) {
                $('#addObsSelectAll').prop('checked', true);
            } else if (selected === 0) {
                $('#addObsSelectAll').prop('checked', false);
            } else {
                $('#addObsSelectAll').prop('checked', false);
            }
        }

        $('#addObsResults').on('change', '#addObsSelectAll', function(){
            const checked = this.checked;
            $('#addObsList .addObsRowCk').prop('checked', checked);
            updateAddObsSelectionState();
        });
        $('#addObsResults').on('change', '.addObsRowCk', function(){
            updateAddObsSelectionState();
        });

        $('#addObsConfirm').click(function(){
            const selectedIds = Array.from(document.querySelectorAll('#addObsList .addObsRowCk:checked')).map(el => el.getAttribute('data-id'));
            if (selectedIds.length === 0) {
                showToast('No observations selected', false);
                return;
            }
            const selectedObservations = selectedIds.map(id => previewCache[id]).filter(Boolean);
            addObservationsToForm(selectedObservations);
            $('#addObsModal').hide();
        });


        $('#observationInputs').on('click', '.removeButton', function() {
            const input = $(this).closest('.observation-input');
            if ($('.observation-input').length > 1) {
                input.remove();
                updateObservationNumbers();
                updateWarningMessage();
            } else {
                input.find('.obs-input').val('');
                input.find('.result').empty();
            }
        });

        addObservationField();
    });
</script>

</body>
</html>
